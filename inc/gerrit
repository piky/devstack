#!/bin/bash
#
# **inc/gerrit** - Gerrit-related functions
#
# Support for Gerrit patch related functions
#
# External functions used:
# - base_patchset_ref
# - latest_patchset_ref

# Save trace setting
INC_GERRIT_TRACE=$(set +o | grep xtrace)
set +o xtrace

# Gerrit Functions
# ================

UPSTREAM_REMOTE=https://review.openstack.org

function get_project {
    local change_num=$1
    #json has an extra )]}' on the first line. Strip it away.
    local json=$(curl -XGET -s $UPSTREAM_REMOTE/changes/?q=$change_num | tail -n +2)
    #jq --raw-output will strip the quotes around the string
    local project=$(echo $json | jq --raw-output '.[0].project')
    echo $project
}

# Get the gerrit patchset ref for a given change number
# patchset_ref
function base_patchset_ref {
    local change_num=$1
    local patchset_ref=refs/changes/${change_num:(-2)}/$change_num
    echo $patchset_ref
}

# fetch latest patchset from gerrit change number
# latest_patchset
function latest_patchset_ref {
    local change_num=$1
    local project=$(get_project $change_num)
    local patchset_ref=$(base_patchset_ref $change_num)
    local ref=$(git ls-remote $UPSTREAM_REMOTE/$project $patchset_ref/\* |
                      sort -t/ -k 5 -n | tail -n1 | cut -d$'\t' -f2)
    echo $ref
}

# Restore xtrace
$INC_GERRIT_TRACE

# Local variables:
# mode: shell-script
# End:
