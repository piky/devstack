- hosts: all
  pre_tasks:
    - name: Gather minimum local MTU
      set_fact:
        local_mtu: >
          {% set mtus = [] -%}
          {% for interface in ansible_interfaces -%}
            {% set _ = mtus.append(hostvars[inventory_hostname]['ansible_' + interface]['mtu']|int) -%}
          {% endfor -%}
          {{- mtus|min -}}
    - name: Calculate external_bridge_mtu
      # 50 bytes is overhead for vxlan (which is greater than GRE
      # allowing us to use either overlay option with this MTU.
      # TODO(andreaf) This should work, but it may have to be reconcilied with
      # the MTU setting used by the multinode setup roles in multinode pre.yaml
      set_fact:
        external_bridge_mtu: "{{ local_mtu | int - 50 }}"
  roles:
    - test-matrix
    - configure-swap
    - setup-stack-user
    - setup-tempest-user
    - setup-devstack-source-dirs
    - setup-devstack-log-dir
    - setup-devstack-cache
    - start-fresh-logging
    - write-devstack-local-conf
    # Setup cross-node passwordless ssh for the stack user
    - role: copy-build-sshkey
      copy_sshkey_target_user: stack
    post_tasks:
      - name: Check passwordless ssh connection as root
        become: true
        shell: "ssh {{ item }} echo hostname -f"
        with_items:
          - "{{ hostvars.controller.nodepool.private_ipv4 }}"
          - "{{ hostvars.compute1.nodepool.private_ipv4 }}"
      - name: Check passwordless ssh connection as stack
        become: true
        become_user: stack
        shell: "ssh {{ item }} echo hostname -f"
        with_items:
          - "{{ hostvars.controller.nodepool.private_ipv4 }}"
          - "{{ hostvars.compute1.nodepool.private_ipv4 }}"
