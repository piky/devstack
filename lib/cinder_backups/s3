#!/bin/bash
#
# lib/cinder_backup/s3
# Configure the s3 backup driver

# Enable with:
#
#   CINDER_BACKUP_DRIVER=s3

# Dependencies:
#
# - ``functions`` file
# - ``cinder`` configurations

# Save trace setting
_XTRACE_CINDER_S3=$(set +o | grep xtrace)
set +o xtrace

function configure_cinder_backup_s3 {
    # This configuration requires swift and s3api. If we're
    # on a subnode we might not know if they are enabled
    iniset $CINDER_CONF DEFAULT backup_driver "cinder.backup.drivers.s3.S3BackupDriver"
    iniset $CINDER_CONF DEFAULT backup_s3_endpoint_url "$SWIFT_SERVICE_PROTOCOL://$SERVICE_HOST:$S3_SERVICE_PORT"
}

function init_cinder_backup_s3 {
    openstack ec2 credential create
    iniset $CINDER_CONF DEFAULT backup_s3_store_access_key "$(openstack ec2 credential list -c Access -f value)"
    iniset $CINDER_CONF DEFAULT backup_s3_store_secret_key "$(openstack ec2 credential list -c Secret -f value)"
    if is_service_enabled tls-proxy; then
        iniset $CINDER_CONF DEFAULT backup_s3_CAcert_file "$SSL_BUNDLE_FILE"
    fi
}

# Restore xtrace
$_XTRACE_CINDER_S3

# Local variables:
# mode: shell-script
# End:
