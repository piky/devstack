#!/bin/bash

# Neutron metering plugin
# ---------------------------

# Save trace setting
_XTRACE_NETURON_METER=$(set +o | grep xtrace)
set +o xtrace


AGENT_METERING_BINARY="$NEUTRON_BIN_DIR/neutron-metering-agent"
METERING_PLUGIN="neutron.services.metering.metering_plugin.MeteringPlugin"
METERING_DRIVER=${METERING_DRIVER:-"neutron.services.metering.drivers.iptables.iptables_driver.IptablesMeteringDriver"}
METERING_INTERFACE_DRIVER=${METERING_INTERFACE_DRIVER:-"neutron.agent.linux.interface.OVSInterfaceDriver"}

function neutron_agent_metering_configure_common {
    _neutron_service_plugin_class_add $METERING_PLUGIN
}

function neutron_agent_metering_configure_agent {
    METERING_AGENT_CONF_PATH=/etc/neutron/services/metering
    mkdir -p $METERING_AGENT_CONF_PATH

    METERING_AGENT_CONF_FILENAME="$METERING_AGENT_CONF_PATH/metering_agent.ini"

    cp $NEUTRON_DIR/etc/metering_agent.ini.sample $METERING_AGENT_CONF_FILENAME
    iniset $METERING_AGENT_CONF_FILENAME DEFAULT driver $METERING_DRIVER
    iniset $METERING_AGENT_CONF_FILENAME DEFAULT interface_driver $METERING_INTERFACE_DRIVER
}

function neutron_metering_stop {
    stop_process q-metering
}

# Restore xtrace
$_XTRACE_NETURON_METER

