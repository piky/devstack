# lib/opendaylight
# Functions to control the configuration and operation of the opendaylight service

# Dependencies:
#
# - ``functions`` file
# # ``DEST`` must be defined
# # ``STACK_USER`` must be defined

# ``stack.sh`` calls the entry points in this order:
#
# - is_opendaylight_enabled
# - install_opendaylight
# - configure_opendaylight
# - init_opendaylight
# - start_opendaylight
# - stop_opendaylight
# - cleanup_opendaylight

# Save trace setting
XTRACE=$(set +o | grep xtrace)
set +o xtrace


# Defaults
# --------

# The IP address of ODL. Set this in local.conf.
# ODL_MGR_IP=

# <define global variables here that belong to this project>
ODL_DIR=$DEST/opendaylight

# The OpenDaylight Package, currently using 'Hydrogen' release
ODL_PKG=distributions-virtualization-0.1.1-osgipackage.zip

# The OpenDaylight URL
ODL_URL=https://nexus.opendaylight.org/content/repositories/opendaylight.release/org/opendaylight/integration/distributions-virtualization/0.1.1

# Set up default directories


# Entry Points
# ------------

# Test if any OpenDaylight services are enabled
# is_opendaylight_enabled
function is_opendaylight_enabled {
    [[ ,${ENABLED_SERVICES} =~ ,"opendaylight" ]] && return 0
    return 1
}

# cleanup_opendaylight() - Remove residual data files, anything left over from previous
# runs that a clean run would need to clean up
function cleanup_opendaylight {
    :
}

# configure_opendaylight() - Set config files, create data dirs, etc
function configure_opendaylight {
    local _pwd=$(pwd)

    # Ensure this is set, if not, die.
    if [ "$ODL_MGR_IP" == "" ]; then
        die $LINENO "When using OpenDaylight, you must configure ODL_MGR_IP to the IP of OpenDaylight."
    fi

    if is_ubuntu; then
        install_package maven openjdk-7-jre openjdk-7-jdk
    else
        yum_install maven java-1.7.0-openjdk
    fi

    # Download OpenDaylight
    mkdir -p $ODL_DIR
    cd $ODL_DIR
    wget -N $ODL_URL/$ODL_PKG
    unzip -u $ODL_PKG

    # Remove simple forwarder
    rm -f $ODL_DIR/opendaylight/plugins/org.opendaylight.controller.samples.simpleforwarding*

    # Configure OpenFlow 1.3
    echo "ovsdb.of.version=1.3" >> $ODL_DIR/opendaylight/configuration/config.ini
}

# init_opendaylight() - Initialize databases, etc.
function init_opendaylight {
    # clean up from previous (possibly aborted) runs
    # create required data files
    :
}

# install_opendaylight() - Collect source and prepare
function install_opendaylight {
    :
}

# start_opendaylight() - Start running processes, including screen
function start_opendaylight {
    if is_ubuntu; then
        JHOME=/usr/lib/jvm/java-1.7.0-openjdk-amd64
    else
        JHOME=/usr/lib/jvm/java-1.7.0-openjdk
    fi
    screen_it opendaylight "cd $ODL_DIR/opendaylight && JAVE_HOME=$JHOME ./run.sh -XX:MaxPermSize=384m -of13 -virt ovsdb"

    # Sleep a bit to let OpenDaylight finish starting up
    sleep 45
}

# stop_opendaylight() - Stop running processes (non-screen)
function stop_opendaylight {
    :
}

# Restore xtrace
$XTRACE

# Tell emacs to use shell-script-mode
## Local variables:
## mode: shell-script
## End:
