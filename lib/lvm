# lib/lvm
# Configure the default LVM volume group used by Cinder and Nova

# Dependencies:
#
# - ``functions`` file
# - ``cinder`` configurations

# CINDER_CONF
# DATA_DIR

# clean_default_volume_group - called from clean()
# configure_default_volume_group - called from configure()
# init_default_volume_group - called from init()


# Save trace setting
MY_XTRACE=$(set +o | grep xtrace)
set +o xtrace

# Defaults
# --------

# Name of the lvm volume group to be used by Nova and Cinder
DEFAULT_VOLUME_GROUP_NAME=stack-volumes-default
DEFAULT_BACKING_FILE=$DATA_DIR/${DEFAULT_VOLUME_GROUP_NAME}-backing-file

# Entry Points
# ------------
# _clean_volume_group removes all default LVM volumes
#
# Usage: clean_default_volume_group
function _clean_volume_group {
    # Clean out existing volumes
    sudo lvremove -f $DEFAULT_VOLUME_GROUP_NAME
}

# _clean_default_lvm_backing_file() removes the backing file of the
# volume group used by default
#
# Usage: _clean_backing_file()
function _clean_backing_file {
    # if there is no logical volume left, it's safe to attempt a cleanup
    # of the backing file
    if [[ -z "$(sudo lvs --noheadings -o lv_name $DEFAULT_VOLUME_GROUP_NAME 2>/dev/null)" ]]; then
        # if the backing physical device is a loop device, it was probably setup by devstack
        local vg_dev=$(sudo losetup -j $DEFAULT_BACKING_FILE | awk -F':' '/backing-file/ { print $1}')
        if [[ -n "$vg_dev" ]] && [[ -e "$vg_dev" ]]; then
            sudo losetup -d $vg_dev
            rm -f $DEFAULT_BACKING_FILE
        fi
    fi
}

# _create_default_volume_group creates default volume group
#
# Usage: _create_default_volume_group()
function _create_default_volume_group {
    if ! sudo vgs $DEFAULT_VOLUME_GROUP_NAME; then
        # Only create if the file doesn't already exists
        [[ -f $DATA_DIR/$DEFAULT_BACKING_FILE ]] || truncate -s $VOLUME_BACKING_FILE_SIZE $DEFAULT_BACKING_FILE
        local vg_dev=`sudo losetup -f --show $DEFAULT_BACKING_FILE`

        # Only create if the loopback device doesn't contain $VOLUME_GROUP_NAME
        if ! sudo vgs $DEFAULT_VOLUME_GROUP_NAME; then
            sudo vgcreate $DEFAULT_VOLUME_GROUP_NAME $vg_dev
        fi
    fi
}

# init_default_volume_group() initializes the stack-volumes-default volume group
# creating the backing file if necessary
#
# Usage: init_default_volume_group()
function init_default_volume_group {
    # Start with a clean volume group
    _create_default_volume_group

    if is_fedora || is_suse; then
        # service is not started by default
        start_service tgtd
    fi

    # Remove iscsi targets
    sudo tgtadm --op show --mode target | grep Target | cut -f3 -d ' ' | sudo xargs -n1 tgt-admin --delete || true

    _clean_volume_group
}

# clean_default_volume_group() cleans up the stack-volumes-default volume group
# and removes the backing file
function clean_default_volume_group {
    _clean_volume_group
    _clean_backing_file
}

# Restore xtrace
$MY_XTRACE

# mode: shell-script
# End:
