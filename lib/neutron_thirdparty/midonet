#!/bin/bash
#
# MidoNet
# -------

# This file implements functions required to configure MidoNet as the third-party
# system used with devstack's Neutron.  To include this file, specify the following
# variables in localrc:
#
# * enable_service midonet
#
# Save trace setting
MN3_XTRACE=$(set +o | grep xtrace)
set +o xtrace

# MidoNet repo
MIDONET_REPO=${MIDONET_REPO:-http://github.com/midonet/midonet.git}
MIDONET_BRANCH=${MIDONET_BRANCH:-master}
MIDONET_DIR=${MIDONET_DIR:-$DEST/midonet}

# MidoNet plugin repo
MIDONET_PLUGIN_REPO=${MIDONET_PLUGIN_REPO:-http://github.com/midonet/python-neutron-plugin-midonet}
MIDONET_PLUGIN_BRANCH=${MIDONET_PLUGIN_BRANCH:-master}

# MidoNet service endpoint configuration
MIDONET_API_PORT=${MIDONET_API_PORT:-8081}
MIDONET_SERVICE_PROTOCOL=${MIDONET_SERVICE_PROTOCOL:-$SERVICE_PROTOCOL}
MIDONET_SERVICE_HOST=${MIDONET_SERVICE_HOST:-$SERVICE_HOST}
MIDONET_API_URL="${MIDONET_SERVICE_PROTOCOL}://${MIDONET_SERVICE_HOST}:${MIDONET_API_PORT}/midonet-api"


function configure_midonet {

    # Update database tables
    midonet-db-manage upgrade head
}

function init_midonet {
    :
}

function install_midonet {

    # Clone and build midonet service
    git_clone $MIDONET_REPO $MIDONET_DIR $MIDONET_BRANCH
    source $MIDONET_DIR/tools/devmido/midostack.sh mido

    # Clone and build neutron midonet plugin
    pip_install -e "git+${MIDONET_PLUGIN_REPO}@${MIDONET_PLUGIN_BRANCH}#egg=python-neutron-plugin-midonet" --src $DEST
}

function start_midonet {
    :
}

function stop_midonet {
    source $MIDONET_DIR/tools/devmido/midostack.sh unmido
}

function check_midonet {
    :
}

# Restore xtrace
$MN3_XTRACE
