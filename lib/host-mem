#!/bin/bash

# Kernel Samepage Merging (KSM)
# -----------------------------

# Processes that mark their memory as mergeable can share identical memory
# pages if KSM is enabled. This is particularly useful for nova + libvirt
# backends but any other setup that marks its memory as mergeable can take
# advantage. The drawback is there is higher cpu load; however, we tend to
# be memory bound not cpu bound so enable KSM by default but allow people
# to opt out if the CPU time is more important to them.
ENABLE_KSM=$(trueorfalse True ENABLE_KSM)
ENABLE_KSMTUNED=$(trueorfalse True ENABLE_KSMTUNED)
function configure_ksm {
    if [[ $ENABLE_KSMTUNED == "True" ]] ; then
        install_package "ksmtuned"
    fi
    local enable_ksm=$(bool_to_int ENABLE_KSM)
    if [[ -f /sys/kernel/mm/ksm/run ]] ; then
        echo ${enable_ksm} | sudo tee /sys/kernel/mm/ksm/run
    fi
}

# Compressed swap (ZSWAP)
#------------------------

# as noted in the kernel docs https://docs.kernel.org/admin-guide/mm/zswap.html
# Zswap is a lightweight compressed cache for swap pages.
# It takes pages that are in the process of being swapped out and attempts
#to compress them into a dynamically allocated RAM-based memory pool.
# zswap basically trades CPU cycles for potentially reduced swap I/O.
# This trade-off can also result in a significant performance improvement
# if reads from the compressed cache are faster than reads from a swap device.

ENABLE_ZSWAP=$(trueorfalse True ENABLE_ZSWAP)
# lz4 is very fast although it does not have the best compression
# zstd has much better compresssion but more latency
ZSWAP_COMPRESSOR=${ZSWAP_COMPRESSOR:="lz4"}
ZSWAP_ZPOOL=${ZSWAP_ZPOOL:="z3fold"}
ZSWAP_ACCEPT_PERCENT=${ZSWAP_ACCEPT_PERCENT:=80}
function configure_zswap {
    if [[ $ENABLE_KSMTUNED == "True" ]] ; then
        echo ${ZSWAP_COMPRESSOR} | sudo tee /sys/module/zswap/parameters/compressor
        echo ${ZSWAP_ZPOOL} | sudo tee /sys/module/zswap/parameters/zpool
        echo 1 | sudo tee /sys/module/zswap/parameters/same_filled_pages_enabled
        echo 1 | sudo tee /sys/module/zswap/parameters/non_same_filled_pages_enabled
        echo 1 | sudo tee /sys/module/zswap/parameters/enabled
        echo ${ZSWAP_ACCEPT_PERCENT} | sudo tee /sys/module/zswap/parameters/accept_threshold_percent
        # print curent zram kernel config
        grep -R . /sys/module/zswap/parameters
    fi
}


function configure_host_mem {
    configure_zswap
    configure_ksm
}