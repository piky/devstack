#!/usr/bin/python

import socket
import sys
import os
import os.path
import json

server_address = "/tmp/openstack.sock"

sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)

try:
    sock.connect(server_address)
except socket.error, msg:
    print >>sys.stderr, msg
    sys.exit(1)


def send(sock, doc):
    jdoc = json.dumps(doc)
    sock.send('%d\n' % len(jdoc))
    sock.sendall(jdoc)

def recv(sock):
    length_str = ''

    char = sock.recv(1)
    if len(char) == 0:
        print >>sys.stderr, "Unexpected end of file"
        sys.exit(1)

    while char != '\n':
        length_str += char
        char = sock.recv(1)
        if len(char) == 0:
            print >>sys.stderr, "Unexpected end of file"
            sys.exit(1)

    total = int(length_str)
        
    # use a memoryview to receive the data chunk by chunk efficiently
    jdoc = memoryview(bytearray(total))
    next_offset = 0
    while total - next_offset > 0:
        recv_size = sock.recv_into(jdoc[next_offset:], total - next_offset)
        next_offset += recv_size
    try:
        doc = json.loads(jdoc.tobytes())
    except (TypeError, ValueError), e:
        raise Exception('Data received was not in JSON format')
    return doc

try:
    env = {}
    passenv = ["CINDER_VERSION",
               "OS_AUTH_URL",
               "OS_IDENTITY_API_VERSION",
               "OS_NO_CACHE",
               "OS_PASSWORD",
               "OS_PROJECT_NAME",
               "OS_REGION_NAME",
               "OS_TENANT_NAME",
               "OS_USERNAME",
               "OS_VOLUME_API_VERSION"]
    for name in passenv:
        if name in os.environ:
            env[name] = os.environ[name]

    cmd = {
        "app": os.path.basename(sys.argv[0]),
        "env": env,
        "argv": sys.argv[1:]
    }
    send(sock, cmd)

    doc = recv(sock)
    if doc["stdout"] != '':
        print >>sys.stdout, doc["stdout"]
    if doc["stderr"] != '':
        print >>sys.stderr, doc["stderr"]
    sys.exit(doc["status"])
finally:
    sock.close()
