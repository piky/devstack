- name: Generate minimial ceph.conf on controller for subnode
  become: true
  shell: /usr/bin/ceph config generate-minimal-conf > /etc/ceph/client.conf
  args:
    creates: /etc/ceph/client.conf
  when: inventory_hostname == 'controller'

- name: Fetch client.conf and keyrings from controller
  become: true
  fetch:
    src: "{{ item }}"
    dest: "{{ zuul.executor.work_root }}/{{ item | basename }}"
  with_items:
    - "/etc/ceph/client.conf"
    - "/etc/ceph/ceph.client.admin.keyring"
    - "/etc/ceph/ceph.client.cinder.keyring"
    - "/etc/ceph/ceph.client.glance.keyring"
  when: inventory_hostname == 'controller'

- name: Ensure /etc/ceph exists on the subnode
  become: true
  file:
    path: /etc/ceph
    state: directory
  when: 'inventory_hostname in groups["subnode"]|default([])'

- name: Copy client.conf to subnode as /etc/ceph/ceph.conf
  become: true
  copy:
    src: "{{ zuul.executor.work_root }}/client.conf"
    dest: "/etc/ceph/ceph.conf"
  when: 'inventory_hostname in groups["subnode"]|default([])'

- name: Push keyrings to subnode
  become: true
  copy:
    src: "{{ zuul.executor.work_root }}/{{ item | basename }}"
    dest: "/etc/ceph/{{ item | basename }}"
  with_items:
    - "/etc/ceph/ceph.client.admin.keyring"
    - "/etc/ceph/ceph.client.cinder.keyring"
    - "/etc/ceph/ceph.client.glance.keyring" 
  when: 'inventory_hostname in groups["subnode"]|default([])'
