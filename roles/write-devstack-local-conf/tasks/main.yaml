# local_mtu and external_bridge_mtu are available for replacement in
# the local.conf files
- name: Gather minimum local MTU
  set_fact:
    local_mtu: >
      {% set mtus = [] -%}
      {% for interface in ansible_interfaces -%}
        {% set interface_variable = 'ansible_' + interface -%}
        {% if interface_variable in hostvars[inventory_hostname] -%}
          {% set _ = mtus.append(hostvars[inventory_hostname][interface_variable]['mtu']|int) -%}
        {% endif -%}
      {% endfor -%}
      {{- mtus|min -}}
- name: Calculate external_bridge_mtu
  # 50 bytes is overhead for vxlan (which is greater than GRE
  # allowing us to use either overlay option with this MTU.
  # TODO(andreaf) This should work, but it may have to be reconcilied with
  # the MTU setting used by the multinode setup roles in multinode pre.yaml
  set_fact:
    external_bridge_mtu: "{{ local_mtu | int - 50 }}"

- name: Write a job-specific local_conf file
  become: true
  become_user: stack
  devstack_local_conf:
    path: "{{ devstack_local_conf_path }}"
    plugins: "{{ devstack_plugins|default(omit) }}"
    base_services: "{{ devstack_base_services|default(omit) }}"
    services: "{{ devstack_services|default(omit) }}"
    localrc: "{{ devstack_localrc|default(omit) }}"
    local_conf: "{{ devstack_local_conf|default(omit) }}"
    base_dir: "{{ devstack_base_dir|default(omit) }}"
    projects: "{{ zuul.projects }}"
    project: "{{ zuul.project }}"